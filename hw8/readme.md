# 操作系统 作业 8

宋婉婷 2022K8009929009

## 8.1

一台机器虚存采用分段机制，物理内存当前的空闲空间如下 (按物理地址由小到大的顺序):12MB, 5MB, 18MB, 20MB, 8MB, 9MB, 10MB 和 15MB。此时要为三个段分配空间 (按时间先后顺序): 段 A 申请 12MB，段 B 申请 10MB，段 C 申请 9MB。请分别给出采用 Best Fit， Worst Fit，First Fit 和 Next Fit 算法下，每次分配成的空闲空间状态 (按物理地址由小到大顺序)，以及每次分配所需的比较次数。

**答：**

**(1)Best Fit**

此时操作系统先将空闲分区按容量由小到大的顺序排列，即 5MB -> 8MB ->9MB ->10MB ->12MB ->15MB ->18MB ->20MB , 接着从前往后遍历直到为每个段寻找第一个足够容纳的空间。

段 A 分配 12MB 空间，比较次数 5；

段 B 分配 10MB 空间，比较次数 4；

段 C 分配 9MB 空间，比较次数 3。

总比较次数为 12。

最终空闲空间状态 (按物理地址由小到大顺序)：5MB -> 8MB  ->15MB ->18MB ->20MB

**(2)Worst Fit**

此时操作系统先将空闲分区按容量由大到小的顺序排列，即 20MB -> 18MB ->15MB ->12MB ->10MB ->9MB ->8MB ->5MB , 接着从前往后遍历直到为每个段寻找第一个足够容纳的空间。

段 A 分配 20MB 空间，比较次数 1；此时排序为 18MB ->15MB ->12MB ->10MB ->9MB ->8MB ->8MB ->5MB

段 B 分配 18MB 空间，比较次数 1；此时排序为 15MB ->12MB ->10MB ->9MB ->8MB ->8MB ->8MB ->5MB

段 C 分配 15MB 空间，比较次数 1。此时排序为 12MB ->10MB ->9MB ->8MB ->8MB ->8MB ->6MB ->5MB

总比较次数为 3。

最终空闲空间状态 (按物理地址由小到大顺序)：5MB -> 8MB ->9MB ->10MB ->12MB ->6MB ->8MB ->8MB

**(3)First Fit**

此时操作系统先将空闲分区按按物理地址由小到大的顺序排列，即 12MB -> 5MB -> 18MB -> 20MB -> 8MB -> 9MB -> 10MB  -> 15MB，接着从前往后遍历直到为每个段寻找第一个足够容纳的空间。

段 A 分配 12MB 空间，比较次数 1；

段 B 分配 18MB 空间，比较次数 2；

段 C 分配 20MB 空间，比较次数 3。

总比较次数为 6。

最终空闲空间状态 (按物理地址由小到大顺序)：5MB -> 8MB -> 11MB -> 8MB -> 9MB -> 10MB  -> 15MB

**(4)Next Fit**

此时操作系统先将空闲分区按按物理地址由小到大的顺序排列，即 12MB -> 5MB -> 18MB -> 20MB -> 8MB -> 9MB -> 10MB  -> 15MB，接着从前往后遍历直到为每个段寻找第一个足够容纳的空间，并记录每次停止的位置。

段 A 分配 12MB 空间，比较次数 1；

段 B 分配 18MB 空间，比较次数 2；此时指针在 B 剩余的 8MB 空间位置上。

段 C 分配 20MB 空间，比较次数 2。

总比较次数为 5。

最终空闲空间状态 (按物理地址由小到大顺序)：5MB -> 8MB -> 11MB -> 8MB -> 9MB -> 10MB  -> 15MB

## 8.2

假设一台计算机使用 32-bit 的虚拟地址空间和三级页表，虚地址的划分为 8-bit | 6-bit | 6-bit | 12-bit（注：8 bit 对应为第一级页表的地址，以此类推）, 请计算：

（1）该计算机系统的页大小是多少？

（2）该三级页表一共能索引多少个页？

（3）现有一个程序的代码段大小为 132KB，数据段为 86KB，栈大小为 8KB，则在使用上述三级页表时，最少需要占用多少个物理页框？最多会占用多少个物理页框？（注：假设程序各段在地址空间中的布局可以自行决定）

（4）在上述（3）中，假设该计算机使用一级页表进行地址空间管理，则（3）中的程序需要占用多少个物理页框？

**答：**

(1) 页大小为
$$
2^{12}=4kB
$$
(2) 一共能索引
$$
2^8*2^6*2^6=2^{20}\text{页}
$$
(3)

最少：程序段代码段、数据段和栈连续存储，共需 $(132+86+8)\div4=56..2$ 四舍五入 57 页，一级页表能索引 $2^6=64$ 页，则只需 1 个一级页表，1 个二级页表，1 个三级页表，共 60 个物理页框。

最多：程序段代码段、数据段和栈分开存储，分别需要 33、22、2 页，均可分配到 2 个一级页表和 2 个二级页表上，再加上 1 个三级页表，共 $57+2\times3\times2+1=70$ 个物理页框。

(4)

假定页表项为 4B，则需占用
$$
57+2^{20}*4B\div4KB=57+1024=1081\text{个物理页框}
$$

## 8.3

假设一台计算机上运行一个进程 A，该进程的地址空间大小为 8 MB（页大小为 4KB）。该计算机使用线性页表记录进程 A 的虚实映射关系，并且将 A 的页表都保存在内存中。该计算机 CPU 的 TLB 大小为 64 项，每项 4B，一次 TLB 查询或 TLB 填充的延迟均为 5 ns，请计算：

（1）假设该计算机使用软件处理 TLB miss，且操作系统进行一次页表查询的平均延迟为 100 ns，如果想让虚实地址映射的平均延迟为 40 ns，那么 TLB 的命中率应为多少？如果想让虚实地址映射的平均延迟不超过 20 ns，那么 TLB 的命中率应为多少？（上述各项操作的延迟不变）

**答：**

TLB hit: 5ns

TLB miss: 5ns + 100ns + 5ns = 110ns

若令平均延迟为 40ns，则有 $rate*5+(1-rate)*110=40$，解得命中率为 66.7%

若令平均延迟为 20ns，则有 $rate*5+(1-rate)*110=20$，解得命中率为 85.7%

## 8.4

现有如下 C 程序

uint32 X[N];

int step = M, i = 0;

for(i=0;i<N;i+=step) X[i] = X[i] + 1;

请计算：

（1） 假设该程序运行在一台计算机上，该计算机的虚址空间为 32-bit，物理地址空间为 2 GB，页大小为 4 KB，如果采用一级页表，则该页表的页表项一共有多少？

（2） 假设该计算机的 CPU 的 TLB 大小为 32 项，每项 4B，那么题述程序中的 M 和 N 取值为多少时，会使得程序中循环的每一次执行都会触发 TLB miss？（假设 TLB 初始为空）

（3） 在（2）中，M 和 N 取值多少时，会使得程序中的循环执行时 TLB hit 最多？（假设 TLB 初始为空）

**答：**

(1) 页大小为 4KB，则 offset 为 12 位，虚拟页有 $2^{32-12}=2^{20}$ 页，若采用一级页表，则每个虚页都对应一个页表项，则页表项有 $2^{20}$ 项

(2)1 个 uint32 值占 4B，1 页可以存放 $4KB\div4B=1024$ 项，若使每一次循环都触发 TLB miss，则令 $M>1024$，此时每一个 X[i] 都在一个新的页上，对 N 没有要求。

(3) 让步长 M 最短为 1，则最大化利用 TLB 空间，同时 N 每增大 1024 就会有 1 次 TLB miss，即 $miss\_rate=(N-1)\div1024+1$，则 N 最小为 1025 时 TLB hit 最多。
